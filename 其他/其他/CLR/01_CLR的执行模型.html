<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跳一跳的猪的博客</title>
    <meta name="description" content="Hello World">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0822f0c7.css" as="style"><link rel="preload" href="/assets/js/app.95515c58.js" as="script"><link rel="preload" href="/assets/js/2.1e63c646.js" as="script"><link rel="preload" href="/assets/js/31.4ad32a16.js" as="script"><link rel="prefetch" href="/assets/js/10.63c10e9a.js"><link rel="prefetch" href="/assets/js/11.7d9955f5.js"><link rel="prefetch" href="/assets/js/12.f40b8dc7.js"><link rel="prefetch" href="/assets/js/13.bd10cedd.js"><link rel="prefetch" href="/assets/js/14.ca04ea7b.js"><link rel="prefetch" href="/assets/js/15.057b383c.js"><link rel="prefetch" href="/assets/js/16.17f85a0e.js"><link rel="prefetch" href="/assets/js/17.00380992.js"><link rel="prefetch" href="/assets/js/18.02ac9a73.js"><link rel="prefetch" href="/assets/js/19.49a49d79.js"><link rel="prefetch" href="/assets/js/20.8c5d19b0.js"><link rel="prefetch" href="/assets/js/21.23feb2ff.js"><link rel="prefetch" href="/assets/js/22.7943b80e.js"><link rel="prefetch" href="/assets/js/23.19abfcba.js"><link rel="prefetch" href="/assets/js/24.a8b7c3a2.js"><link rel="prefetch" href="/assets/js/25.245c92f0.js"><link rel="prefetch" href="/assets/js/26.5f3536b1.js"><link rel="prefetch" href="/assets/js/27.81ed09c2.js"><link rel="prefetch" href="/assets/js/28.eac509c8.js"><link rel="prefetch" href="/assets/js/29.6a3135ea.js"><link rel="prefetch" href="/assets/js/3.f173e7b6.js"><link rel="prefetch" href="/assets/js/30.9d52e7b2.js"><link rel="prefetch" href="/assets/js/32.a8037ea1.js"><link rel="prefetch" href="/assets/js/33.b2e21ebf.js"><link rel="prefetch" href="/assets/js/34.fdfe7603.js"><link rel="prefetch" href="/assets/js/35.3466d40b.js"><link rel="prefetch" href="/assets/js/36.8cb79e41.js"><link rel="prefetch" href="/assets/js/37.18705617.js"><link rel="prefetch" href="/assets/js/38.f76854ed.js"><link rel="prefetch" href="/assets/js/39.989f5c0b.js"><link rel="prefetch" href="/assets/js/4.bb9dbcd4.js"><link rel="prefetch" href="/assets/js/40.b2a9a658.js"><link rel="prefetch" href="/assets/js/5.966df546.js"><link rel="prefetch" href="/assets/js/6.f9219fb0.js"><link rel="prefetch" href="/assets/js/7.f7f0e67b.js"><link rel="prefetch" href="/assets/js/8.11a2bc7e.js"><link rel="prefetch" href="/assets/js/9.031d86af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0822f0c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">跳一跳的猪的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">C</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/C/基础/" class="nav-link">基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">CSharp</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CSharp/DotNetCore/" class="nav-link">DotNetCore</a></li><li class="dropdown-item"><!----> <a href="/CSharp/基础/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/CSharp/练习/" class="nav-link">练习</a></li></ul></div></div><div class="nav-item"><a href="/JS/" class="nav-link">JS</a></div><div class="nav-item"><a href="/Linux/" class="nav-link">Linux</a></div><div class="nav-item"><a href="/MySql/" class="nav-link">MySql</a></div><div class="nav-item"><a href="/Python/" class="nav-link">Python</a></div><div class="nav-item"><a href="/其他/" class="nav-link">其他</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">C</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/C/基础/" class="nav-link">基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">CSharp</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CSharp/DotNetCore/" class="nav-link">DotNetCore</a></li><li class="dropdown-item"><!----> <a href="/CSharp/基础/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/CSharp/练习/" class="nav-link">练习</a></li></ul></div></div><div class="nav-item"><a href="/JS/" class="nav-link">JS</a></div><div class="nav-item"><a href="/Linux/" class="nav-link">Linux</a></div><div class="nav-item"><a href="/MySql/" class="nav-link">MySql</a></div><div class="nav-item"><a href="/Python/" class="nav-link">Python</a></div><div class="nav-item"><a href="/其他/" class="nav-link">其他</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>其他</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E5%85%B6%E4%BB%96/" class="sidebar-link">前言</a></li><li><a href="/其他/科学上网.html" class="sidebar-link">科学上网</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>[TOC]</p> <h3 id="将源代码编译成托管模块"><a href="#将源代码编译成托管模块" aria-hidden="true" class="header-anchor">#</a> 将源代码编译成托管模块</h3> <p>公共语言运行时（Common Language Runtime, CLR)：一个可由多种编程语言使用的“运行时”</p> <p>CLR 的核心功能（比如内存管理、程序集加载、安全性、异常处理和线程同步）可由面向 CLR 的所有语言使用。</p> <p>无论选择哪个编译器，结果都是托管模块（managed module）</p> <p>托管模块：标准的32位 Microsoft Windows 可移植执行体（PE32）文件或标准的64位，都需要 CLR 才能执行。</p> <p>可移植执行体：PE（Portable Executable）</p> <p>托管程序集总是利用 Windows 的数据执行保护（Data Execution Prevention，DEP）和地址空间布局随机化（Address Space Layout Randomization，ASLR），这两个功能旨在增强整个系统的安全性。</p> <h4 id="托管模块"><a href="#托管模块" aria-hidden="true" class="header-anchor">#</a> 托管模块</h4> <ol><li><p>PE32 或 PE32+头</p></li> <li><p>CLR 头:包含使用这个模块成为托管模块的信息（可由 CLR 和一些实用程序进行解释）</p></li> <li><p>元数据：每个托管模块都包含元数据表。</p> <ul><li>主要有两种表：
<ul><li>描述源代码中定义的类型和成员</li> <li>描述源代码引用的类型和成员</li></ul></li> <li>用途（部分）：
<ul><li>避免了编译时对原生 C/C++头和库文件的需求，因为在实现类型/成员的 IL 代码文件中，已包含有关引用类型/成员的全部信息。编译器直接从托管模块读取元数据。</li> <li>VS 用元数据帮助你写代码。智能感知（IntelliSense）技术会解析元数据，告诉一个类型提供了哪些方法、属性、事件和字段。对于方法，还能告诉你需要的参数。</li> <li>CLR 的代码验证过程使用元数据确保代码只执行“类型安全”的操作</li> <li>元数据允许将对象的字段序列化到内存块，将其发送给另一条机器，然后反序列化，在远程机器上重建对象状态。</li> <li>元数据允许垃圾回收器跟踪对象生存期。垃圾回收器能判断任何对象的类型，并从元数据知道那个对象的哪些字段引用了其他对象。</li></ul></li></ul></li> <li><p>IL（中间语言）代码：编译器编译源代码生成的代码。在运行时，CLR 将 IL 编译成本机 CPU 指令</p></li></ol> <p>Microsoft 的 C++ 编译器默认生成包含非托管（native）代码的 EXE/DLL 模块，并在运行时操纵非托管数据（native 内存）。这些模块不需要 CLR 即可执行。然而，通过制定 CLR 命令行开关，C++ 编译器就能生成包含托管代码的模块，当然，最终用户必须安装 CLR 才能执行这种代码。</p> <h4 id="将托管模块合并成程序集"><a href="#将托管模块合并成程序集" aria-hidden="true" class="header-anchor">#</a> 将托管模块合并成程序集</h4> <p>CLR 实际不和模块工作。和程序集工作。</p> <p><strong>程序集</strong>（assembly）是一个或多个模块/资源文件的逻辑性分组。其次，程序集是重用、安全性以及版本控制的最小单元。取决于你选择的编译器或工具，既可生产单文件程序集，也可生成多文件程序集。</p> <p>在 CLR 的世界里，程序集相当于组件。</p> <p><img src="https://github.com/smallupbig/MyNote/blob/master/Res/pic_CLR/1_1.png" alt="1.1将托管模块合并成程序集"></p> <p>在程序集的模块中，还包含与引用的程序集有关的信息（包括它们的版本号）。这些信息使程序集能够自描述（self-describing）。也就是，CLR 能判断为了执行程序集的代码，程序集的直接依赖对象（immediate dependency)是什么。不需要注册表或 Active Directory Domain Services(ADDS)中保存额外的信息。由于无需额外信息，所以和非托管组件相比，程序集更容易部署。</p> <h4 id="加载公共语言运行时"><a href="#加载公共语言运行时" aria-hidden="true" class="header-anchor">#</a> 加载公共语言运行时</h4> <p>生成的每个程序集既可以是可执行应用程序，也可以是 DLL（其中含有一组由可执行程序使用的类型）。最终是由 CLR 管理这些程序集中的代码的执行。</p> <h4 id="执行程序集的代码"><a href="#执行程序集的代码" aria-hidden="true" class="header-anchor">#</a> 执行程序集的代码</h4> <p>托管程序集同时包含元数据和IL。
<strong>IL</strong> 是与 CPU 无关的机器语言，是 Microsoft 在请教了外面的几个商业及学术性语言/编译器的作者之后，费尽心思开发出来的。
<strong>IL</strong> 比大多数 CPU 机器语言都高级。
<strong>IL</strong> 能访问和操作对象类型，并提供了指令来创建和初始化对象、调用对象上的虚方法以及直接操作数组元素。甚至提供了抛出和捕捉异常的指令来实现错误处理。可将 IL 视为一种面向对象的机器语言。
高级语言通常只公开了 CLR 全部功能的一个自己。然而，IL 汇编语言允许开发人员访问 CLR 的全部功能。所以，如果选择的编程语言隐藏了迫切需要的一个 CLR 功能，可以换用 IL 汇编语言或者提供了所需功能的另一种编程语言来写那部分代码。
为了执行方法，首先要把方法的 IL 转换成本机（native）CPU 指令。这是 CLR 的 JIT（just-in-time）编译器的职责。</p> <p><img src="https://github.com/smallupbig/MyNote/blob/master/Res/pic_CLR/1_2.png" alt="1.2执行程序集的代码"> <img src="https://github.com/smallupbig/MyNote/blob/master/Res/pic_CLR/1_3.png" alt="1.3方法的第二次调用"></p> <table><thead><tr><th>编辑器开关设置</th> <th>C# IL 代码质量</th> <th>JIT 本机代码质量</th></tr></thead> <tbody><tr><td>/optimize-/debug-(默认)</td> <td>未优化</td> <td>有优化</td></tr> <tr><td>/optimize-/debug(+/full/pdbonly)</td> <td>未优化</td> <td>未优化</td></tr> <tr><td>/optimize+/debug(-/+/full/pdbonly)</td> <td>有优化</td> <td>有优化</td></tr></tbody></table> <p><strong>JIT</strong> 优势：</p> <ul><li>JIT 编译器能判断应用程序是否运行在 Inter Pentium 4 CPU 上，并生成相应的本机代码来利用 Pentium 4 支持的任何特殊指令。</li> <li>JIT 编译器能判断一个特定的测试在它运行的机器上是否总是失败。例如</li></ul> <div class="language-C# extra-class"><pre class="language-text"><code>	if (numberOfCPUs &gt; 1) {
		...
	}
</code></pre></div><p>如果本机只有一个 CPU，JIT 编译器不会为上述代码生成任何 CPU 指令，在这种情况下，本机代码将针对主机进行优化，最终代码变得更小，执行得更快</p> <ul><li>。。。</li></ul> <h4 id="il-和验证"><a href="#il-和验证" aria-hidden="true" class="header-anchor">#</a> IL 和验证</h4> <p>IL 基于栈。
IL 指令是无类型的（不分 32 位和 64 位，自己进行判断）
将 IL 编译成本机 CPU 指令时，CLR 执行一个名为验证的过程。会去检查高级 IL 代码，确定代码所做的一切都是安全的。
Windows 的每个进程都有自己的虚拟地址空间。独立地址空间之所以重要，是因为不能简单的信任一个应用程序的代码。应用程序完全可能读写无效的内存条地址。将每个 Windows 进程都放到独立的地址空间，将获得健壮性与稳定性：一个进程干扰不到另一个进程。  然而，通过验证托管代码，可以确保代码不会不正确地访问内存，不会干扰到另一个应用程序的代码。这样就可以放心地将多个托管应用程序放到同一个 Windows 虚拟地址空间运行。
由于 Windows 进程需要大量操作系统资源，所以进程数量太多，会损害性能并制约可用的资源。用一个进程运行多个应用程序，可减少进程数，从而增强性能，减少所需的资源
，健壮性也没有丝毫下降。这是托管代码相较于非托管代码的另一个优势。</p> <h4 id="不安全的代码"><a href="#不安全的代码" aria-hidden="true" class="header-anchor">#</a> 不安全的代码</h4> <h4 id="本机代码生成器：ngen-exe"><a href="#本机代码生成器：ngen-exe" aria-hidden="true" class="header-anchor">#</a> 本机代码生成器：NGen.exe</h4> <p>可以在应用程序安装到用户的计算机上去时，将 IL 代码编译成本机代码。
优点：</p> <ol><li>提高应用程序的启动速度</li> <li>减小应用程序的工作集
缺点：</li> <li>没有知识产权保护</li> <li>NGen 生成的文件可能失去同步
CLR 加载 NGen 生成的文件时，会将预编译代码的许多特征与当前执行环境进行比较。任何特征不匹配，NGen 生成的文件就不能用，就要改为使用正常的 JIT 编译器进程。
如：
<ul><li>CLR 版本：随补丁或 Service Pack 改变</li> <li>CPU 类型：升级处理器发生改变</li> <li>WIndows 操作系统版本：安装新 Service Pack 后改变</li> <li>程序集的标识模块版本 ID（Module Version ID， MVID）：重新编译后改变</li> <li>引用的程序集的版本 ID：重新编译引用的程序集后改变</li> <li>安全性：吊销了额之前授予的权限之后，安全性就会发生改变。</li></ul></li> <li>较差的执行时性能
编译代码时，NGen 无法像 JIT 编译器那样对执行环境进行许多假定。会生成交叉的代码</li></ol> <h4 id="framework-类库（fcl）"><a href="#framework-类库（fcl）" aria-hidden="true" class="header-anchor">#</a> Framework 类库（FCL）</h4> <h4 id="通用类型系统"><a href="#通用类型系统" aria-hidden="true" class="header-anchor">#</a> 通用类型系统</h4> <p>通用类型系统（Common Type System，CTS）</p> <h4 id="公共语言规范（common-language-specification，-cls）"><a href="#公共语言规范（common-language-specification，-cls）" aria-hidden="true" class="header-anchor">#</a> 公共语言规范（Common Language Specification， CLS）</h4> <p>详细定义了一个最小功能集。任何编译器只有支持这个功能集，生成的类型才能兼容由其他符合 CLS、面向 CLS 的语言生成的组件。</p> <h4 id="与非托管代码的互操作性"><a href="#与非托管代码的互操作性" aria-hidden="true" class="header-anchor">#</a> 与非托管代码的互操作性</h4> <ul><li>托管代码能调用 DLL 中的非托管函数</li> <li>托管代码可以使用现有的 COM 组件（服务器）</li> <li>非托管代码可以使用托管类型（服务器）</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.95515c58.js" defer></script><script src="/assets/js/2.1e63c646.js" defer></script><script src="/assets/js/31.4ad32a16.js" defer></script>
  </body>
</html>
